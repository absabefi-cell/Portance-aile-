<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Portance ‚Äî aile param√©trable (altitude + graphe)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#101826; --ink:#eaf2fb; --muted:#9ab0c8;
    --accent:#5ac8fa; --ok:#7ee787; --warn:#ffb86b; --bad:#ff6b6b;
    --grid:#203044; --border:#1d2a3b;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Inter,Roboto,Segoe UI,sans-serif}
  header{padding:12px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#122033,#0b0f14)}
  h1{font-size:18px;margin:0}
  .wrap{display:grid;grid-template-columns:340px 1fr;gap:14px;padding:14px}
  @media (max-width: 980px){.wrap{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .side{padding:12px}
  label{font-size:12px;color:var(--muted);display:block;margin:6px 0 4px}
  .row{display:flex;gap:8px;align-items:center}
  input[type="range"]{width:100%}
  input[type="number"]{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0e1520;color:var(--ink)}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px;font-size:13px;margin-top:8px}
  .kv div:nth-child(odd){color:var(--muted)}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
  .ok{color:var(--ok);border-color:#2a5033}.bad{color:var(--bad);border-color:#5b2a2a}.warn{color:var(--warn);border-color:#5b4a2a}
  .note{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}
  .err{font-size:13px;color:var(--bad);min-height:16px}
  canvas.scene{width:100%;height:48vh;display:block;border-radius:14px}
  canvas.chart{width:100%;height:32vh;display:block;border-radius:14px}
  .legend{display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
  .blue{background:#4aa3ff}.red{background:#ff6b6b}.flow{background:#9ab0c8}
  .toolbar{display:flex;gap:8px;align-items:center;margin-top:8px}
  .btn{padding:8px 10px;border:1px solid var(--border);background:#152033;color:var(--ink);border-radius:10px;cursor:pointer;font-size:13px}
  .tag{font-size:12px;color:#b7c7da}
  .keyL{color:#7ee787}.keyD{color:#ff6b6b}
</style>
</head>
<body>
<header><h1>Portance d‚Äôune aile ‚Äî interactive (altitude + graphe)</h1></header>

<div class="wrap">
  <section class="card side">
    <div class="row" style="gap:12px;align-items:end">
      <div style="flex:1"><label>Vitesse avion V (m/s)</label><input id="V" type="range" min="0" max="120" step="1" value="65"></div>
      <div style="width:90px"><input id="Vn" type="number" min="0" max="300" step="1" value="65"></div>
    </div>

    <div class="row" style="gap:12px;align-items:end">
      <div style="flex:1"><label>Vent (m/s) ‚Äî + = de face</label><input id="wind" type="range" min="-30" max="30" step="1" value="5"></div>
      <div style="width:90px"><input id="windn" type="number" min="-100" max="100" step="1" value="5"></div>
    </div>

    <div class="row" style="gap:12px;align-items:end">
      <div style="flex:1"><label>Angle d‚Äôattaque Œ± (¬∞)</label><input id="alpha" type="range" min="-10" max="18" step="0.5" value="4"></div>
      <div style="width:90px"><input id="alphan" type="number" min="-20" max="30" step="0.5" value="4"></div>
    </div>

    <div class="row" style="gap:12px;align-items:end">
      <div style="flex:1"><label>Courbure du dessus (camber %)</label><input id="camberTop" type="range" min="0" max="8" step="0.1" value="3.0"></div>
      <div style="width:90px"><input id="camberTopn" type="number" min="0" max="20" step="0.1" value="3.0"></div>
    </div>

    <div class="row" style="gap:12px;align-items:end">
      <div style="flex:1"><label>Forme du dessous (‚àí concave, + convexe) %</label><input id="camberBot" type="range" min="-6" max="6" step="0.1" value="0.0"></div>
      <div style="width:90px"><input id="camberBotn" type="number" min="-20" max="20" step="0.1" value="0.0"></div>
    </div>

    <div class="row" style="gap:12px;align-items:end">
      <div style="flex:1"><label>√âpaisseur relative (t %)</label><input id="thick" type="range" min="6" max="18" step="0.5" value="12"></div>
      <div style="width:90px"><input id="thickn" type="number" min="4" max="24" step="0.5" value="12"></div>
    </div>

    <div class="row" style="gap:12px;align-items:end">
      <div style="flex:1"><label>Surface alaire S (m¬≤)</label><input id="S" type="range" min="2" max="60" step="0.5" value="16"></div>
      <div style="width:90px"><input id="Sn" type="number" min="1" max="200" step="0.5" value="16"></div>
    </div>

    <div class="row" style="gap:12px;align-items:end">
      <div style="flex:1"><label>Poids (N)</label><input id="W" type="range" min="1000" max="150000" step="500" value="20000"></div>
      <div style="width:90px"><input id="Wn" type="number" min="100" max="300000" step="100" value="20000"></div>
    </div>

    <div class="row" style="gap:12px;align-items:end">
      <div style="flex:1"><label>Altitude (m)</label><input id="alt" type="range" min="0" max="12000" step="100" value="0"></div>
      <div style="width:90px"><input id="altn" type="number" min="0" max="20000" step="100" value="0"></div>
    </div>

    <div class="toolbar">
      <button class="btn" id="toggle">‚ñ∂Ô∏è Animer</button>
      <label class="tag" style="margin-left:auto">Vitesse anim.</label>
      <input id="aspeed" type="range" min="0.2" max="3" step="0.1" value="1.2" style="flex:1">
      <button class="btn" id="clear">üßπ Reset graphe</button>
    </div>

    <div class="kv" id="readout">
      <div>V air relatif</div><div><span id="Veff">‚Äî</span> m/s</div>
      <div>œÅ air</div><div><span id="rho">‚Äî</span> kg/m¬≥</div>
      <div>C<sub>L</sub> (mod√®le)</div><div><span id="CL">‚Äî</span></div>
      <div>C<sub>D</sub> (mod√®le)</div><div><span id="CD">‚Äî</span></div>
      <div>Portance L</div><div><span id="Lift">‚Äî</span> N</div>
      <div>Tra√Æn√©e D</div><div><span id="Drag">‚Äî</span> N</div>
      <div>√âtat</div><div id="state" class="pill">‚Äî</div>
    </div>
    <div class="note">
      œÅ(alt) via <b>ISA troposph√®re</b> : œÅ ‚âà 1.225¬∑(1 ‚àí 2.25577√ó10‚Åª‚Åµ¬∑h)<sup>4.256</sup> (jusqu‚Äô√† ~11‚Äì12 km).  
      Mod√®le <b>p√©dagogique</b> : C<sub>L</sub> ‚âà 2œÄ(Œ± + effet cambrure), d√©crochage doux.
    </div>
    <div class="err" id="err"></div>
  </section>

  <section class="card">
    <canvas id="cv" class="scene" width="1400" height="720"></canvas>
    <div class="legend">
      <span><span class="dot flow"></span>Lignes de flux (anim√©es)</span>
      <span><span class="dot blue"></span>Pression basse (extrados)</span>
      <span><span class="dot red"></span>Pression haute (intrados)</span>
    </div>
  </section>

  <section class="card">
    <canvas id="chart" class="chart" width="1400" height="420"></canvas>
    <div class="legend">
      <span class="keyL">‚Äî L (N)</span>
      <span class="keyD">‚Äî D (N)</span>
      <span class="tag">temps r√©el (√©chantillons ~10 s)</span>
    </div>
  </section>
</div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const link = (range, num) => {
    const r=$(range), n=$(num);
    const sync = v => { r.value=v; n.value=v; changed(); };
    r.addEventListener('input', ()=> n.value=r.value, {passive:true});
    n.addEventListener('input', ()=> r.value=n.value);
    r.addEventListener('change', changed);
    n.addEventListener('change', changed);
    return sync;
  };

  // Inputs
  const syncV=link('#V','#Vn'), syncWind=link('#wind','#windn'), syncAlpha=link('#alpha','#alphan');
  const syncCamTop=link('#camberTop','#camberTopn'), syncCamBot=link('#camberBot','#camberBotn'), syncThick=link('#thick','#thickn');
  const syncS=link('#S','#Sn'), syncW=link('#W','#Wn'), syncAlt=link('#alt','#altn');

  // Outputs
  const out = {
    Veff: $('#Veff'), rho: $('#rho'), CL: $('#CL'), CD: $('#CD'),
    Lift: $('#Lift'), Drag: $('#Drag'), state: $('#state'), err: $('#err')
  };
  const val = id => parseFloat($(id).value);

  // Scene canvas
  const cv=$('#cv'), ctx=cv.getContext('2d');
  // Chart canvas
  const ch=$('#chart'), g=ch.getContext('2d');

  function resizeHiDPI(canvas, ctx, h=undefined){
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.round(rect.width*dpr);
    canvas.height = Math.round(rect.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  function onResize(){
    resizeHiDPI(cv, ctx);
    resizeHiDPI(ch, g);
    draw(true); // layout compute
    renderChart(); // axes refresh
  }
  window.addEventListener('resize', onResize);

  // Atmosphere (ISA, troposphere approx)
  function rhoISA(h){ // h in m
    const a = 1 - 2.25577e-5 * Math.max(0, Math.min(h, 12000));
    return 1.225 * Math.pow(a, 4.256);
  }

  // Airfoil geometry
  function airfoilPath(ctPct, cbPct, tPct, alphaDeg){
    const t=tPct/100, ct=ctPct/100, cb=cbPct/100, N=120, top=[], bot=[];
    for(let i=0;i<=N;i++){
      const x=i/N;
      const camber = (ct*(1 - ((x-0.4)/0.4)**2)) - (cb*(1 - ((x-0.6)/0.6)**2));
      const yt = 5*t*(0.2969*Math.sqrt(Math.max(x,0)) - 0.1260*x - 0.3516*x*x + 0.2843*x**3 - 0.1015*x**4);
      top.push([x, camber + yt]); bot.push([x, camber - yt]);
    }
    const a = alphaDeg*Math.PI/180;
    const rot=([x,y])=>[(x-0.5)*Math.cos(a)-y*Math.sin(a)+0.5,(x-0.5)*Math.sin(a)+y*Math.cos(a)];
    return { top: top.map(rot), bot: bot.reverse().map(rot) };
  }

  // Aero toy model
  function aeroModel(V, wind, alphaDeg, ct, cb, t, S, rho){
    const Vinf = Math.max(0, V + Math.max(0, wind)); // vent de face >0
    const aRad = alphaDeg*Math.PI/180;
    const camberEff = 0.012*ct - 0.006*cb;
    let CL = 2*Math.PI*(aRad + camberEff);
    const tt = t/100;
    const alphaStall = (10 + 120*tt)/180*Math.PI;
    if (Math.abs(aRad) > alphaStall){
      const sign=Math.sign(CL), excess = (Math.abs(aRad)-alphaStall)/(20*Math.PI/180);
      CL = sign * Math.abs(CL) * (1/(1+excess*excess));
    }
    const CD0 = 0.02 + 0.02*tt, k=0.045;
    const CD = CD0 + k*CL*CL;
    const q = 0.5*rho*Vinf*Vinf, L=q*S*CL, D=q*S*CD;
    return {Vinf, CL, CD, L, D};
  }

  // Mapper
  function mapper(){
    const W=cv.clientWidth, H=cv.clientHeight, pad=40, scale=Math.min(W-2*pad, H-2*pad)*0.9;
    const cx=W*0.35, cy=H*0.55;
    const map=([x,y])=>[cx+(x-0.5)*scale, cy-y*scale];
    return {W,H,pad,scale,cx,cy,map};
  }

  // Animation
  let anim=false, t0=0, last=0;
  const toggle=$('#toggle'), speedEl=$('#aspeed'), clearBtn=$('#clear');
  toggle.addEventListener('click', ()=>{
    anim=!anim; toggle.textContent = anim ? '‚è∏ Pause' : '‚ñ∂Ô∏è Animer';
    if(anim){ t0=performance.now(); last=t0; requestAnimationFrame(loop); }
  });
  clearBtn.addEventListener('click', ()=>{ seriesL.length=0; seriesD.length=0; seriesT.length=0; renderChart(true); });

  // Cached values for renderer
  const cache={ foil:null, CL:0, Vinf:0, L:0, D:0, rho:1.225, W:0 };

  function draw(layoutOnly=false){
    out.err.textContent="";
    const V=val('#V'), wind=val('#wind'), alpha=val('#alpha');
    const ct=val('#camberTop'), cb=val('#camberBot'), t=val('#thick');
    const S=val('#S'), W=val('#W'), h=val('#alt');
    const rho = rhoISA(h);

    const foil=airfoilPath(ct, cb, t, alpha);
    const {Vinf, CL, CD, L, D} = aeroModel(V, wind, alpha, ct, cb, t, S, rho);

    out.Veff.textContent=Vinf.toFixed(1);
    out.rho.textContent=rho.toFixed(3);
    out.CL.textContent=CL.toFixed(3);
    out.CD.textContent=CD.toFixed(3);
    out.Lift.textContent=Math.round(L).toLocaleString('fr-CA');
    out.Drag.textContent=Math.round(D).toLocaleString('fr-CA');

    const ratio = L/W, st=out.state;
    if (Vinf<1){ st.textContent="V‚âà0 : pas d‚Äô√©coulement"; st.className="pill warn"; }
    else if (ratio>=1.05){ st.textContent="L ‚â• W : √ßa vole ‚úÖ"; st.className="pill ok"; }
    else if (ratio>=0.7){ st.textContent="L proche de W (marge faible)"; st.className="pill warn"; }
    else { st.textContent="L < W : insuffisant"; st.className="pill bad"; }

    cache.foil=foil; cache.CL=CL; cache.Vinf=Vinf; cache.L=L; cache.D=D; cache.rho=rho; cache.W=W;
    if(!layoutOnly) renderScene((performance.now()-t0)/1000);
  }

  function renderScene(time){
    const {W,H,scale,cx,cy,map}=mapper();
    const {foil, CL, Vinf} = cache;
    const t = time * parseFloat(speedEl.value) * (0.6 + 0.02*Vinf);

    // Background + pressure wash
    ctx.fillStyle='#0f1724'; ctx.fillRect(0,0,W,H);
    const topGrad=ctx.createLinearGradient(cx, cy-0.6*scale, cx, cy);
    const botGrad=ctx.createLinearGradient(cx, cy, cx, cy+0.6*scale);
    const amp = Math.min(0.6, Math.max(0.2, 0.25 + 0.15*Math.tanh(Math.abs(CL))));
    topGrad.addColorStop(0, `rgba(74,163,255,${0.45+0.25*amp})`); topGrad.addColorStop(1, `rgba(74,163,255,0)`);
    botGrad.addColorStop(0, `rgba(255,107,107,0)`); botGrad.addColorStop(1, `rgba(255,107,107,${0.35+0.2*amp})`);
    ctx.fillStyle=topGrad; ctx.fillRect(cx-0.6*scale, cy-0.7*scale, 1.2*scale, 0.7*scale);
    ctx.fillStyle=botGrad; ctx.fillRect(cx-0.6*scale, cy, 1.2*scale, 0.7*scale);

    // Grid
    ctx.strokeStyle='#1f2a38'; ctx.lineWidth=1;
    for(let x=40;x<W-40;x+=40){ ctx.beginPath(); ctx.moveTo(x,40); ctx.lineTo(x,H-40); ctx.stroke(); }
    for(let y=40;y<H-40;y+=40){ ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(W-40,y); ctx.stroke(); }

    // Airfoil
    ctx.fillStyle='#d9e6f7'; ctx.strokeStyle='#8fa9c7'; ctx.lineWidth=2;
    ctx.beginPath(); const f0=map(foil.top[0]); ctx.moveTo(f0[0],f0[1]);
    foil.top.forEach(p=>{ const m=map(p); ctx.lineTo(m[0],m[1]); });
    foil.bot.forEach(p=>{ const m=map(p); ctx.lineTo(m[0],m[1]); });
    ctx.closePath(); ctx.fill(); ctx.stroke();

    // Streamlines + moving arrows/particles
    const lines=10;
    for(let k=0;k<lines;k++){
      const yk=-0.35 + k*(0.7/(lines-1));
      ctx.strokeStyle='rgba(154,176,200,0.9)'; ctx.lineWidth=1.6;
      const x0=-0.25, x3=1.35;
      const bump=0.22 + 0.12*Math.tanh(CL);
      const c1=[0.23, yk-bump], c2=[0.78, yk+0.08];
      const P=(tt)=>{ const bx=(1-tt)**3*x0+3*(1-tt)**2*tt*c1[0]+3*(1-tt)*tt**2*c2[0]+tt**3*x3;
                      const by=(1-tt)**3*yk+3*(1-tt)**2*tt*c1[1]+3*(1-tt)*tt**2*c2[1]+tt**3*yk; return map([bx,by]); };
      ctx.beginPath(); const pS=P(0); ctx.moveTo(pS[0],pS[1]); for(let i=1;i<=32;i++){ const p=P(i/32); ctx.lineTo(p[0],p[1]); } ctx.stroke();
      const base=(k/lines)*0.8, tt=(t*0.35+base)%1, pM=P(tt), pN=P(Math.min(1,tt+0.02));
      const ang=Math.atan2(pN[1]-pM[1], pN[0]-pM[0]);
      ctx.save(); ctx.translate(pM[0],pM[1]); ctx.rotate(ang);
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(12,0); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(12,0); ctx.lineTo(6,-3); ctx.lineTo(6,3); ctx.closePath(); ctx.fillStyle='rgba(154,176,200,0.95)'; ctx.fill(); ctx.restore();
      for(let j=0;j<3;j++){ const tpp=(t*0.2+j*0.3+base)%1, pp=P(tpp); ctx.fillStyle='rgba(154,176,200,0.75)'; ctx.beginPath(); ctx.arc(pp[0],pp[1],1.6,0,6.28); ctx.fill(); }
    }

    // Lift vector
    const pulse=1+0.08*Math.sin(t*4);
    const liftLen=Math.min(120,(40+Math.abs(CL)*50)*pulse);
    ctx.strokeStyle='#7ee787'; ctx.fillStyle='#7ee787'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(cx+0.7*scale, cy); ctx.lineTo(cx+0.7*scale, cy-liftLen); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx+0.7*scale, cy-liftLen); ctx.lineTo(cx+0.7*scale-5, cy-liftLen+10); ctx.lineTo(cx+0.7*scale+5, cy-liftLen+10); ctx.closePath(); ctx.fill();
  }

  // === Chart (L & D vs temps) ===
  const seriesT=[], seriesL=[], seriesD=[];
  function pushSample(t, L, D){
    seriesT.push(t); seriesL.push(L); seriesD.push(D);
    // garder ~ 10 s √† 30 fps ‚âà 300 points
    const maxN=350;
    if(seriesT.length>maxN){ seriesT.splice(0,seriesT.length-maxN); seriesL.splice(0,seriesL.length-maxN); seriesD.splice(0,seriesD.length-maxN); }
  }

  function renderChart(clearOnly=false){
    const W=ch.clientWidth, H=ch.clientHeight, pad=40;
    // bg
    g.fillStyle='#0f1724'; g.fillRect(0,0,W,H);
    // axes
    g.strokeStyle='#1f2a38'; g.lineWidth=1;
    for(let x=pad;x<W-pad;x+=60){ g.beginPath(); g.moveTo(x,pad); g.lineTo(x,H-pad); g.stroke(); }
    for(let y=pad;y<H-pad;y+=40){ g.beginPath(); g.moveTo(pad,y); g.lineTo(W-pad,y); g.stroke(); }
    if(clearOnly || seriesT.length<2) return;

    const t0=seriesT[0], t1=seriesT[seriesT.length-1];
    const Lmin=Math.min(...seriesL), Lmax=Math.max(...seriesL);
    const Dmin=Math.min(...seriesD), Dmax=Math.max(...seriesD);
    const ymin=0, ymax=Math.max(Lmax, Dmax)*1.1 || 1;

    const X=t=> pad + (t - t0)/(t1 - t0) * (W - 2*pad);
    const Y=v=> H - pad - (v - ymin)/(ymax - ymin) * (H - 2*pad);

    // Labels
    g.fillStyle='#9ab0c8'; g.font='12px system-ui';
    g.fillText('t (s)', W - pad - 20, H - 10);
    g.fillText('Force (N)', 10, pad - 8);

    // L curve
    g.strokeStyle='#7ee787'; g.lineWidth=2; g.beginPath();
    g.moveTo(X(seriesT[0]), Y(seriesL[0]));
    for(let i=1;i<seriesT.length;i++) g.lineTo(X(seriesT[i]), Y(seriesL[i]));
    g.stroke();

    // D curve
    g.strokeStyle='#ff6b6b'; g.lineWidth=2; g.beginPath();
    g.moveTo(X(seriesT[0]), Y(seriesD[0]));
    for(let i=1;i<seriesT.length;i++) g.lineTo(X(seriesT[i]), Y(seriesD[i]));
    g.stroke();
  }

  function loop(now){
    const dt = (now - last)/1000; last=now;
    const tsec = (now - t0)/1000;
    draw(true); // update cache
    renderScene(tsec);
    // sample L & D ~30 fps
    pushSample(tsec, cache.L, cache.D);
    renderChart();
    if(anim) requestAnimationFrame(loop);
  }

  function changed(){ draw(false); }

  // Init
  onResize();
  syncV($('#V').value); syncWind($('#wind').value); syncAlpha($('#alpha').value);
  syncCamTop($('#camberTop').value); syncCamBot($('#camberBot').value); syncThick($('#thick').value);
  syncS($('#S').value); syncW($('#W').value); syncAlt($('#alt').value);
})();
</script>
</body>
  </html>
